(Do&&Do.ready?Do.ready:$)(function(){function t(t){return dui.Dialog($.extend({width:525},t),!0)}function e(t,e,i,n){t.submit(function(t){t.preventDefault();var a=$(this),o=a.attr("action");$.ajax({type:(a.attr("method")||"POST").toUpperCase(),url:o,data:$.map(a.serializeArray(),n||r),dataType:i,success:e,error:function(){e({r:!1,reason:"服务器开小差了，稍后再试吧"})}}),a.trigger("afterSubmit")})}function i(t,e){"end"===e&&(e=t.value.length),l(t,e,e)}function n(t){if(!t.data("isPollingForChange")){var e=t.val();setInterval(function(){var i=t.val();e!==i&&t.trigger("actualChange")},250)}}function a(t,e){var i=t.val().length,n=d-i,a=n<0;e.text(n.toString(10))[a?"addClass":"removeClass"]("error"),t.trigger(a?"limitExceed":"limitFufill")}function r(t){return t}function o(t){return t=t.clone(),t.find("[data-id]").each(function(t,e){e=$(e),e.text("@"+e.data("id"))}),t.text()}var d=140;$("[data-share-dialog]").bind("click",function(r){r.preventDefault();var d=$(this),l=d.data("dialog-title"),u=$(d.data("share-dialog")).html();window.sharingDialog=t({title:l,content:u}),setTimeout(function(){sharingDialog.update().open()},20);var c=sharingDialog.node,s=(c.find(".notification"),c.find("textarea")),f=c.find(".avail-num-indicator"),g=c.find(":submit"),h=c.find(".mentioned-highlighter");c.addClass("movie-share-dialog"),i(s.get(0),0),n(s),s.bind("actualChange",function(){a(s,f)}),s.textbox({itemCount:6,dataUrl:s.data("mention-api"),listTmpl:$("#suggest-mention-tmpl").html(),highlighter:h}),a(s,f),s.bind({limitExceed:function(){g.attr("disabled",!0)},limitFufill:function(){g.removeAttr("disabled")}});var m=c.find("form"),v=c.find(".error"),p=m.find("input").add(m.find("textarea"));m.bind("afterSubmit",function(){v.hide(),p.attr("disabled",!0)}),e(m,function(t){return t.r?(sharingDialog.setContent(['<p class="dialog-only-text">',"分享成功!","</p>"].join("")).set({height:155}),void setTimeout(function(){sharingDialog.close()},1500)):(c.find(".error").hide().text(t.reason||"服务器开小差了，请稍候再试……").fadeIn(),void p.removeAttr("disabled"))},"json",function(t){return"text"===t.name&&(t.value=o(h)||t.value),t})});var l=document.selection?function(t,e,i){var n=t.createTextRange();n.moveEnd("character",-t.value.length),n.moveEnd("character",i),n.moveStart("character",e),n.select()}:function(t,e,i){t.setSelectionRange(e,i),t.focus()}});